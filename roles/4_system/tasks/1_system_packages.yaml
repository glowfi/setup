---
############################################################
# AUR HELPER
############################################################

- name: Check if yay is installed
  ansible.builtin.command: which yay
  register: yay_check
  changed_when: false
  failed_when: false

- name: Install yay
  when: yay_check.rc != 0
  block:
    - name: Ensure base-devel installed
      community.general.pacman:
        name: base-devel
        state: present
      become: true

    - name: Clone yay-bin repository
      ansible.builtin.git:
        repo: https://aur.archlinux.org/yay-bin.git
        dest: /tmp/yay-bin
        update: no
      retries: 5

    - name: Build yay package
      ansible.builtin.command: makepkg -s --noconfirm
      args:
        chdir: /tmp/yay-bin
        creates: /tmp/yay-bin/yay-bin-*.pkg.tar.zst
      become: false

    - name: Find the regular yay package
      find:
        paths: /tmp/yay-bin
        patterns: "yay-bin-*.pkg.tar.zst"
        excludes: "*debug*.pkg.tar.zst"
        file_type: file
        recurse: no
      register: yay_pkg

    - name: Install yay with pacman
      community.general.pacman:
        name: "{{ yay_pkg.files[0].path }}"
        state: present
      become: true

    - name: Allow passwordâ€‘less pacman and yay for members of the wheel group
      become: true
      ansible.builtin.copy:
        dest: /etc/sudoers.d/pacman-yay
        owner: root
        group: root
        mode: '0440'
        content: |
          {{ ansible_user }} ALL=(ALL) NOPASSWD: /usr/bin/pacman, /usr/bin/yay

  always:
    - name: Remove yay build directory
      ansible.builtin.file:
        path: /tmp/yay-bin
        state: absent

############################################################
# CORE Packages
############################################################

- name: Install core main packages
  community.general.pacman:
    name:
      - zip
      - unzip
      - unrar
      - p7zip
      - lzop
      - ouch
      - man-db
      - fish
      - kitty
      - jq
      - aria2
    state: present
    update_cache: true
  become: true
  retries: 5

############################################################
# CORE (Fonts)
############################################################

- name: Install core fonts
  community.general.pacman:
    name:
      - ttf-fantasque-sans-mono
      - noto-fonts
      - noto-fonts-emoji
    state: present
  become: true
  retries: 5

- name: Install AUR fonts
  yay:
    name:
      - ttf-fantasque-nerd
      - ttf-joypixels
      - ttf-ms-fonts
      - ttf-vista-fonts
    state: present
  retries: 5


############################################################
# CORE (AUDIO)
############################################################

- name: Install audio packages systemd variant
  community.general.pacman:
    name:
      - alsa-utils
      - alsa-plugins
      - pipewire
      - pipewire-alsa
      - pipewire-pulse
      - pipewire-jack
      - wireplumber
    state: present
  when: os == "arch"
  become: true
  retries: 5

- name: Install audio packages openrc variant
  community.general.pacman:
    name:
      - alsa-utils-openrc
      - alsa-plugins
      - pipewire-openrc
      - pipewire-alsa
      - pipewire-pulse-openrc
      - pipewire-jack
      - wireplumber-openrc
    state: present
  when: os == "artix"
  become: true
  retries: 5

- name: Install Bluetooth packages
  community.general.pacman:
    name:
      - bluez
      - bluez-utils
      - blueman
    state: present
  become: true
  retries: 5

- name: Install audio utilities
  community.general.pacman:
    name:
      - songrec
      - easyeffects
      - lsp-plugins
    state: present
  become: true
  retries: 5

- name: Ensure EasyEffects config directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ ansible_env.HOME }}/.config/easyeffects"
    - "{{ ansible_env.HOME }}/.config/easyeffects/output"

- name: Download EasyEffects preset installer
  get_url:
    url: https://raw.githubusercontent.com/JackHack96/PulseEffects-Presets/master/install.sh
    dest: /tmp/easyeffects-install.sh
    mode: "0755"
  retries: 5

- name: Run EasyEffects installer non-interactively
  ansible.builtin.shell: |
    echo | bash /tmp/easyeffects-install.sh

- name: Remove EasyEffects installer
  ansible.builtin.file:
    path: /tmp/easyeffects-install.sh
    state: absent

- name: Enable PipeWire services
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    state: started
    enabled: true
    scope: user
  loop:
    - pipewire
    - wireplumber
    - pipewire-pulse
  when: os == "arch"

- name: Enable PipeWire services
  become: false
  ansible.builtin.command:
    cmd: "rc-update --user add {{ item }} default"
  loop:
    - pipewire
    - pipewire-pulse
    - wireplumber
  when: os == "artix"

############################################################
# CORE (VIDEO)
############################################################

- name: Install video packages
  community.general.pacman:
    name:
      - ffmpeg
      - yt-dlp
      - mujs
      - mpv
    state: present
  become: true
  retries: 5

############################################################
# CORE (IMAGE)
############################################################

- name: Install image tools
  community.general.pacman:
    name:
      - imagemagick
      - ffmpegthumbnailer
    state: present
  become: true
  retries: 5

############################################################
# CORE (EXTRAS)
############################################################

- name: Install extra utilities
  community.general.pacman:
    name:
      - android-tools
      - scrcpy
      - gpick
      - mediainfo
      - perl-image-exiftool
      - inotify-tools
      - libnotify
      - gum
    state: present
  become: true
  retries: 5

- name: Install localsend
  yay:
    name: localsend-bin
    state: present
  retries: 5

############################################################
# IMAGE
############################################################

- name: Install GIMP
  community.general.pacman:
    name: gimp
    state: present
  become: true
  retries: 5

- name: Remove existing GIMP config directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.config/GIMP/3.0"
    state: absent

- name: Recreate GIMP config directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.config/GIMP/3.0"
    state: directory
    mode: "0755"

- name: Clone PhotoGIMP repository
  ansible.builtin.git:
    repo: https://github.com/Diolinux/PhotoGIMP
    dest: "{{ ansible_env.HOME }}/.config/GIMP/3.0/PhotoGIMP"
    depth: 1
  retries: 5

- name: Copy PhotoGIMP config into GIMP directory
  ansible.builtin.copy:
    src: "{{ ansible_env.HOME }}/.config/GIMP/3.0/PhotoGIMP/.config/GIMP/3.0/"
    dest: "{{ ansible_env.HOME }}/.config/GIMP/3.0/"
    remote_src: true

- name: Remove PhotoGIMP repo and unwanted directories
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.config/GIMP/3.0/{{ item }}"
    state: absent
  loop:
    - PhotoGIMP
    - filters
    - plug-ins
    - splashes

############################################################
# VIDEO
############################################################

- name: Install kdenlive
  community.general.pacman:
    name: kdenlive
    state: present
  become: true
  retries: 5

############################################################
# EXTRAS
############################################################

- name: Install libreoffice
  community.general.pacman:
    name: libreoffice-fresh
    state: present
  become: true
  retries: 5

- name: Install tectonic
  community.general.pacman:
    name: tectonic
    state: present
  become: true
  retries: 5

############################################################
# TERMINAL TOMFOOLERY
############################################################

- name: Install terminal fun packages
  community.general.pacman:
    name:
      - fortune-mod
      - lolcat
      - cmatrix
      - asciiquarium
      - cowsay
      - figlet
      - sl
    state: present
  become: true
  retries: 5

- name: Clone figlet fonts repository
  ansible.builtin.git:
    repo: https://github.com/xero/figlet-fonts
    dest: /tmp/figlet-fonts
    update: no
  retries: 5

- name: Ensure figlet fonts directory exists
  ansible.builtin.file:
    path: /usr/share/figlet/fonts
    state: directory
    mode: "0755"
  become: true

- name: Copy figlet fonts into system
  ansible.builtin.copy:
    src: /tmp/figlet-fonts/
    dest: /usr/share/figlet/fonts/
    remote_src: true
  become: true

- name: Remove temporary figlet directory
  ansible.builtin.file:
    path: /tmp/figlet-fonts
    state: absent
  become: true

############################################################
# Writing Tools
############################################################

- name: Install rnote
  community.general.pacman:
    name: rnote
    state: present
  become: true
  retries: 5

############################################################
# CLONE DOTFILES REPO
############################################################

- name: Clone dotfiles repository
  ansible.builtin.git:
    repo: https://github.com/glowfi/dotfiles.git
    dest: "/home/{{ ansible_user }}/.dotfiles"
    update: yes
  become: false
  retries: 5


############################################################
# FISH CONFIG
############################################################

- name: Ensure fish config directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/.config/fish"
    state: directory
    mode: "0755"

- name: Copy fish config
  ansible.builtin.copy:
    src: "/home/{{ ansible_user }}/.dotfiles/configs/fish/"
    dest: "/home/{{ ansible_user }}/.config/fish/"
    remote_src: true


############################################################
# BASH / INPUTRC / VIMRC (USER)
############################################################

- name: Copy bashrc
  ansible.builtin.copy:
    src: "/home/{{ ansible_user }}/.dotfiles/configs/.bashrc"
    dest: "/home/{{ ansible_user }}/.bashrc"
    remote_src: true

- name: Copy inputrc
  ansible.builtin.copy:
    src: "/home/{{ ansible_user }}/.dotfiles/configs/.inputrc"
    dest: "/home/{{ ansible_user }}/.inputrc"
    remote_src: true

- name: Copy vimrc
  ansible.builtin.copy:
    src: "/home/{{ ansible_user }}/.dotfiles/configs/.vimrc"
    dest: "/home/{{ ansible_user }}/.vimrc"
    remote_src: true


############################################################
# BASH / INPUTRC / VIMRC (Root)
############################################################

- name: Copy bashrc to root
  ansible.builtin.copy:
    src: "/home/{{ ansible_user }}/.bashrc"
    dest: "/root/.bashrc"
    remote_src: true
  become: true

- name: Copy inputrc to root
  ansible.builtin.copy:
    src: "/home/{{ ansible_user }}/.inputrc"
    dest: "/root/.inputrc"
    remote_src: true
  become: true

- name: Copy vimrc to root
  ansible.builtin.copy:
    src: "/home/{{ ansible_user }}/.vimrc"
    dest: "/root/.vimrc"
    remote_src: true
  become: true

############################################################
# NNN INSTALL
############################################################

- name: Install nnn dependencies
  community.general.pacman:
    name:
      - trash-cli
      - tree
    state: present
  become: true
  retries: 5

- name: Clone NNN
  ansible.builtin.git:
    repo: https://github.com/jarun/nnn
    dest: /tmp/nnn
    depth: 1
  retries: 5

- name: Build NNN binary
  ansible.builtin.command: >
    sudo make O_NERD=1 install
  args:
    chdir: /tmp/nnn
  become: true

- name: Ensure nnn plugin directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/.config/nnn/plugins"
    state: directory
    mode: "0755"

- name: Install nnn plugins
  ansible.builtin.shell: curl -Ls https://raw.githubusercontent.com/jarun/nnn/master/plugins/getplugs | sh
  args:
    chdir: "/home/{{ ansible_user }}/.config/nnn/plugins"
    creates: "/home/{{ ansible_user }}/.config/nnn/plugins/autojump"


############################################################
# KITTY CONFIG
############################################################

- name: Ensure kitty config directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/.config/kitty"
    state: directory

- name: Copy kitty config
  ansible.builtin.copy:
    src: "/home/{{ ansible_user }}/.dotfiles/configs/kitty/"
    dest: "/home/{{ ansible_user }}/.config/kitty/"
    remote_src: true


############################################################
# PACMAN STATIC
############################################################

- name: Ensure local bin exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/.local/bin"
    state: directory
    mode: "0755"

- name: Download pacman-static
  get_url:
    url: https://pkgbuild.com/~morganamilo/pacman-static/x86_64/bin/pacman-static
    dest: "/home/{{ ansible_user }}/.local/bin/pacman-static"
    mode: "0755"


############################################################
# CHANGE DEFAULT SHELL
############################################################

- name: Change default shell to fish
  user:
    name: "{{ ansible_user }}"
    ansible.builtin.shell: /bin/fish
  become: true
