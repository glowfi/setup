# VIRTUALIZATION SUPPORT

#--INSTALL

### ULTRA MINIMAL 
yay -S --noconfirm quickemu quickgui-bin qemu-audio-pa qemu-ui-sdl

### MINIMAL
sudo pacman -S --noconfirm qemu-base edk2-ovmf qemu-ui-sdl

### FULL
sudo pacman -S dnsmasq virt-manager qemu-base ebtables edk2-ovmf qemu-ui-sdl
sudo usermod -G libvirt -a "$USER"
sudo systemctl start libvirtd


#--UNINSTALL
sudo pacman -Rns dnsmasq virt-manager qemu-base edk2-ovmf qemu-ui-sdl
sudo gpasswd -d "$USER" libvirt

# BOOT VIRTUAL MACHINE
# Help : http://odi.ch/prog/uefi.php
# Help : https://wiki.qemu.org/Hosts/BSD

cp -r /usr/share/edk2-ovmf/x64/OVMF_VARS.fd . 
qemu-img create -f qcow2 Image.img 20G

qemu-system-x86_64 -enable-kvm \
	-bios /usr/share/edk2-ovmf/x64/OVMF_CODE.fd \
	-machine q35,accel=kvm,smm=on \
	-cpu host \
	-boot menu=on \
	-global driver=cfi.pflash01,property=secure,value=on \
	-drive if=pflash,format=raw,unit=0,file=/usr/share/edk2-ovmf/x64/OVMF_CODE.fd,readonly=on \
	-drive if=pflash,format=raw,unit=1,file=OVMF_VARS.fd \
	-drive file=Image.img \
	-m 8G \
	-smp 6 \
	-vga virtio \
	-display sdl,gl=on \
	-cdrom ISO_NAME

##### EXTRA

VFIO Link : https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md

# GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 quiet lsm=landlock,lockdown,yama,apparmor,bpf"

GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 lsm=landlock,lockdown,yama,apparmor,bpf amd_iommu=on vfio-pci.ids=10de:25a2,10de:2291"
sudo grub-mkconfig -o /boot/grub/grub.cfg

sudo -E nvim /etc/modprobe.d/vfio.conf  
options vfio-pci ids=10de:25a2,10de:2291
softdep nvidia pre: vfio-pci
sudo mkinitcpio -p linux-zen

sudo qemu-system-x86_64 \
	-enable-kvm \
	-bios /usr/share/edk2-ovmf/x64/OVMF_CODE.fd \
	-machine q35,accel=kvm,smm=on \
	-cpu host \
	-m 10G \
	-smp 6 \
	-vga virtio \
	-display sdl,gl=on \
	-boot menu=on \
	-device vfio-pci,host=01:00.0,multifunction=on \
	-device vfio-pci,host=01:00.1 \
	-serial none \
	-parallel none \
	-global driver=cfi.pflash01,property=secure,value=on \
	-drive if=pflash,format=raw,unit=0,file=/usr/share/edk2-ovmf/x64/OVMF_CODE.fd,readonly=on \
	-drive if=pflash,format=raw,unit=1,file=OVMF_VARS.fd \
	-drive file=Image.img \
	-drive file=win10.iso,index=1,media=cdrom \
	-drive file=virtio.iso,index=2,media=cdrom

sudo qemu-system-x86_64 \
	-enable-kvm \
	-bios /usr/share/edk2-ovmf/x64/OVMF_CODE.fd \
	-machine q35,accel=kvm,smm=on \
	-cpu host \
	-m 10G \
	-smp 6 \
	-vga virtio \
	-display sdl \
	-boot menu=on \
    -audiodev id=audio1,driver=spice \
    -spice port=5900,addr=127.0.0.1,disable-ticketing=on,image-compression=off,seamless-migration=on \
    -device ich9-intel-hda,id=sound0,bus=pcie.0,addr=0x1b -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 \
    -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 \
	-device vfio-pci,host=01:00.0,multifunction=on \
	-device vfio-pci,host=01:00.1 \
	-serial none \
	-parallel none \
	-global driver=cfi.pflash01,property=secure,value=on \
	-drive if=pflash,format=raw,unit=0,file=/usr/share/edk2-ovmf/x64/OVMF_CODE.fd,readonly=on \
	-drive if=pflash,format=raw,unit=1,file=OVMF_VARS.fd \
	-drive file=Image.img \
	-cdrom win10.iso

    Win10_22H2_English_x64.iso

### SCRIPT TO AUTOMATE
#!/bin/bash

if [[ "$1" = "pass" ]]; then

	## EDIT GRUB
	sudo sed -i '6s/.*/GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 lsm=landlock,lockdown,yama,apparmor,bpf amd_iommu=on vfio-pci.ids=10de:25a2,10de:2291"/' /etc/default/grub
	sudo grub-mkconfig -o /boot/grub/grub.cfg

	## EDIT vfio.conf
	sudo -E nvim -c ":q" /etc/modprobe.d/vfio.conf
	sudo echo | sudo tee /etc/modprobe.d/vfio.conf >/dev/null
	sudo echo "options vfio-pci ids=10de:25a2,10de:2291" | sudo tee -a /etc/modprobe.d/vfio.conf >/dev/null
	sudo echo "softdep nvidia pre: vfio-pci" | sudo tee -a /etc/modprobe.d/vfio.conf >/dev/null
	sudo sed -i "1d" /etc/modprobe.d/vfio.conf
	sudo mkinitcpio -p linux-zen
else

	## EDIT GRUB
	sudo sed -i '6s/.*/GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 quiet lsm=landlock,lockdown,yama,apparmor,bpf"/' /etc/default/grub
	sudo grub-mkconfig -o /boot/grub/grub.cfg

	## DELETE vfio.conf
	sudo rm -rf /etc/modprobe.d/vfio.conf
	sudo mkinitcpio -p linux-zen
fi

### BSD Virtualization 

qemu-system-x86_64 \
	-enable-kvm \
	-bios /usr/share/edk2-ovmf/x64/OVMF_CODE.fd \
	-machine q35,accel=kvm,smm=on \
	-cpu host \
	-m 10G \
	-smp 6 \
	-vga virtio \
	-display sdl,gl=on \
	-boot menu=on \
	-serial none \
	-parallel none \
	-global driver=cfi.pflash01,property=secure,value=on \
	-drive if=pflash,format=raw,unit=0,file=/usr/share/edk2-ovmf/x64/OVMF_CODE.fd,readonly=on \
	-drive if=pflash,format=raw,unit=1,file=OVMF_VARS.fd \
	-drive file=Image.img \
    -device virtio-net,netdev=vmnic -netdev user,id=vmnic,hostfwd=tcp::5222-:22 \
	-cdrom NAME

sudo qemu-system-x86_64 \
	-enable-kvm \
	-bios /usr/share/edk2-ovmf/x64/OVMF_CODE.fd \
	-machine q35,accel=kvm,smm=on \
	-cpu host \
	-m 10G \
	-smp 6 \
	-vga virtio \
	-display sdl,gl=on \
	-boot menu=on \
	-device vfio-pci,host=01:00.0,multifunction=on \
	-device vfio-pci,host=01:00.1 \
	-serial none \
	-parallel none \
	-global driver=cfi.pflash01,property=secure,value=on \
	-drive if=pflash,format=raw,unit=0,file=/usr/share/edk2-ovmf/x64/OVMF_CODE.fd,readonly=on \
	-drive if=pflash,format=raw,unit=1,file=OVMF_VARS.fd \
	-drive file=Image.img \
    -device virtio-net,netdev=vmnic -netdev user,id=vmnic,hostfwd=tcp::5222-:22 \
	-cdrom NAME



# UNINSTALL NNN FM

sudo rm -rf /usr/local/bin/nnn
sudo rm -rf /usr/local/share/man/man1/nnn.1
sudo rm -rf .config/nnn

# UNINSTALL NEOVIM

sudo rm /usr/local/bin/nvim
sudo rm -r /usr/local/share/nvim/


### FIREFOX SUPPORT

# SCRIPT

#!/bin/bash

# Settings

original=$(echo 'user_pref("keyword.enabled", false);')
required=$(echo 'user_pref("keyword.enabled", true);')

# Get Default-release Location

findLocation=$(find ~/.mozilla/firefox/ | grep -E "default-release" | head -1)

# Activate Settings

cd "$findLocation"
wget https://raw.githubusercontent.com/arkenfox/user.js/master/user.js -O user.js
sed -i "s/$original/$required/g" user.js
cd

## Browser
#super + b
# firefox

## Alternate Browser Profile
#super + shift + b
# firefox -p "surf"

# vim.cmd("let g:mkdp_browser = '/usr/bin/brave'")
